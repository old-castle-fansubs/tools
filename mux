#!/usr/bin/python3
import os
import re
import subprocess
import argparse
import zlib


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('ep')
    parser.add_argument('-v', '--version', type=int, default=1)
    return parser.parse_args()


def scan(directory):
    for entry in os.scandir(os.path.realpath(os.path.expanduser(directory))):
        if entry.is_file():
            yield entry.path
        elif entry.is_dir():
            for item in scan(entry.path):
                yield item


def get(paths, regex):
    for path in paths:
        if re.match(regex, path, re.I):
            return path
    return None


def get_many(paths, regex):
    for path in paths:
        if re.match(regex, path, re.I):
            yield path


def mux(video_path, subs_path, chapters_path, font_paths, output_path):
    mux_args = ['mkvmerge', '-o', output_path, video_path]

    if subs_path:
        mux_args.extend([subs_path])

    if chapters_path:
        mux_args.extend(['--chapters', chapters_path])

    for font_path in font_paths:
        mux_args.extend([
            '--attachment-mime-type', 'application/x-truetype-font',
            '--attach-file', font_path
        ])

    status = subprocess.run(mux_args)
    if status.returncode != 0:
        raise RuntimeError('Error while muxing')


def get_checksum(path):
    with open(path, 'rb') as handle:
        return zlib.crc32(handle.read()) & 0xFFFFFFFF


def main():
    args = parse_args()
    if len(args.ep) != 3:
        raise ValueError('Ep number must be 3 characters')

    files = list(scan('.'))

    series = os.path.basename(os.getcwd())
    subs_file = get(files, r'.*(?<!\d)%s(?!\d).*\.ass' % args.ep)
    video_file = get(files, r'.*source.*(?<!\d)%s(?!\d).*\.(avi|mkv)' % args.ep)
    chapters_file = get(files, r'.*chapters.*(?<!\d)%s(?!\d).*\.txt' % args.ep)
    font_files = get_many(files, r'.*/fonts/.*\.[ot]tf')

    desired_checksum = (
        (get_checksum(video_file) & 0xFFFF0000)
        | (args.version << 12)
        | int(args.ep))
    output_file = 'muxed/[OldCastle] %s - %s [%08X].mkv' % (
        series, args.ep, desired_checksum)

    mux(video_file, subs_file, chapters_file, font_files, 'tmp.mkv')

    status = subprocess.run([
        'crcmanip', 'patch', 'tmp.mkv', 'tmp2.mkv', '%08x' % desired_checksum])
    if status.returncode != 0:
        raise RuntimeError('Error while patching CRC')

    print('%08x' % get_checksum('tmp2.mkv'))

    os.unlink('tmp.mkv')
    os.rename('tmp2.mkv', output_file)


if __name__ == '__main__':
    main()

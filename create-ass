#!/usr/bin/env python3
import argparse
import re
import sys
from pathlib import Path
from subprocess import run, PIPE

import lxml.etree
import pysubs2


VIDEO_EXTENSIONS = {'.mkv', '.mp4'}
ASS_EXTENSIONS = {'.ass'}
NOTICE = 'Script generated by bubblesub\nhttps://github.com/rr-/bubblesub'


def str_to_ms(text):
    result = re.match('''
        ^(?P<sign>[+-])?
        (?:(?P<hour>\\d+):)?
        (?P<minute>\\d\\d):
        (?P<second>\\d\\d)\\.
        (?P<millisecond>\\d+)$''', text.strip(), re.VERBOSE)

    if result:
        sign = result.group('sign')
        hour = int(result.group('hour'))
        minute = int(result.group('minute'))
        second = int(result.group('second'))
        millisecond = int(float('0.' + result.group('millisecond')) * 1000)
        ret = ((((hour * 60) + minute) * 60) + second) * 1000 + millisecond
        if sign == '-':
            ret = -ret
        return ret
    raise ValueError(f'Invalid time "{text}"')


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('source', type=Path, nargs='+')
    return parser.parse_args()


def extract_chapters(source_path):
    out = run(['mkvextract', source_path, 'chapters', '-'], stdout=PIPE).stdout
    if not out:
        return
    xml = lxml.etree.XML(out)
    for chapter_atom in xml.xpath('//ChapterAtom'):
        title = chapter_atom.xpath('string(.//ChapterString)')
        start = chapter_atom.xpath('string(.//ChapterTimeStart)')
        end = chapter_atom.xpath('string(.//ChapterTimeEnd)')
        yield pysubs2.SSAEvent(
            start=str_to_ms(start),
            end=str_to_ms(start),
            text=title,
            name='[chapter]',
            type='Comment')


def main():
    args = parse_args()

    subs = pysubs2.SSAFile()
    del subs.info['Collisions']

    for source in args.source:
        if not source.exists():
            raise RuntimeError(f'File "{source}" does not exist.')

        if source.suffix in VIDEO_EXTENSIONS:
            subs.aegisub_project['Audio File'] = \
                subs.aegisub_project['Video File'] = str(source)
            for event in extract_chapters(source):
                subs.append(event)
            if 'PlayResY' not in subs.info:
                subs.info['PlayResY'] = 288

        elif source.suffix in ASS_EXTENSIONS:
            other_subs = pysubs2.SSAFile.load(source)
            for key in {'YCbCr Matrix', 'PlayResX', 'PlayResY', 'Title'}:
                if key in other_subs.info:
                    subs.info[key] = other_subs.info[key]
            for line in other_subs:
                if line.name.startswith('[') \
                or line.style.lower().startswith((
                        'opening', 'ending', 'op', 'ed', 'lyrics', 'karaoke')):
                    subs.append(line)
            subs.styles = other_subs.styles

        else:
            raise RuntimeError(f'Don\'t know what to do with "{source}".')

    for event in subs:
        event.text = re.sub(r'{TIME:\d+,\d+}', '', event.text)
        event.text = f'{{TIME:{event.start},{event.end}}}{event.text}'

    print(subs.to_string(header_notice=NOTICE, format_='ass'), end='')


if __name__ == '__main__':
    try:
        main()
    except RuntimeError as ex:
        print(ex, file=sys.stderr)
